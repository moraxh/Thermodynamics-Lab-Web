---
  import { db } from '@db/connection'
  import { Video } from "@db/tables"
  import Icon from '@src/components/common/Icon.astro'
  import ActionButtons from './ActionButtons.astro'
  import AddButton from './AddButton.astro'
  import VideoViewer from '@src/components/common/VideoViewer.astro'
  import CustomModal from '@src/components/common/CustomModal.astro'

  const videos = await db.select().from(Video).orderBy(Video.uploadedAt)

  const formatDate = (date: Date) => {
    const parts = date.toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }).split(' ');

    if (parts.length >= 5) {
      parts[2] = parts[2].charAt(0).toUpperCase() + parts[2].slice(1); // Capitaliza el mes
    }

    return parts.join(' ');
  }
---

<VideoViewer />

<section class="flex flex-col gap-4 p-5 rounded-lg border border-gray2">
  <article>
    <h2 class="text-2xl font-bold text-text">Gestion de Videos</h2>
    <p class="text-gray-600">Aquí puedes gestionar todos los videos de la plataforma.</p>
  </article>

  <AddButton label="Agregar Video" onclick="onVideoAdd()" />

  <div class="overflow-auto max-w-[90vw] max-h-[1000px]">
    <table id="videosTable">
      <thead>
        <tr>
          <th class="min-w-88 max-w-88">Titulo</th>
          <th class="min-w-72 max-w-72">Descripcion</th>
          <th class="min-w-40 max-w-40">Miniatura</th>
          <th class="min-w-32 max-w-32">Video</th>
          <th class="min-w-42 max-w-42">Fecha de Publicación</th>
          <th class="min-w-32 max-w-32">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {videos.length > 0 ? 
          videos.map((video) => (
            <tr data-id={video.id}>
              <td>{video.title}</td>
              <td>{video.description}</td>
              <td>
                <img 
                  src={`/${video.thumbnailPath}`}
                  class="min-h-20 max-h-32 h-full rounded mx-auto imgViewer"
                  alt="Miniatura"
                  />
              </td>
              <td>
                <a class="flex justify-center hover:cursor-pointer" onclick={`window.videoViewer.show("${video.videoPath.startsWith('http') ? video.videoPath : `/${video.videoPath}`}", "${video.title}")`}>
                  <Icon name="eye" class="stroke-accent w-8 hover:bg-accent hover:stroke-black stroke-2 outline-2 outline-accent p-2 aspect-square rounded-full" />
                </a>
              </td>
              <td>{formatDate(video.uploadedAt)}</td>
              <td>
                <ActionButtons 
                  onEdit={`onVideoEdit("${video.id}")`}
                  onDelete={`onVideoDelete("${video.id}")`}
                />
              </td>
            </tr>
          )) : (
          <tr>
            <td colspan="6" class="text-center py-4">No hay videos registrados.</td>
          </tr>
        )}
      </tbody>
    </table>
  </div>
</section>

<!-- Modal para agregar video -->
<CustomModal id="addVideoModal" class="w-full max-w-4xl">
  <div class="bg-gray0 rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto border border-gray2">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-text">Agregar Nuevo Video</h3>
      <button onclick="window.customModal.hide('addVideoModal')" class="text-gray3 hover:text-text transition-colors">
        <Icon name="xmark" class="w-6 h-6 fill-current" />
      </button>
    </div>

    <form id="addVideoForm" class="space-y-6">
      <!-- Título -->
      <div>
        <label for="videoTitle" class="block text-sm font-medium text-text mb-2">Título *</label>
        <input 
          type="text" 
          id="videoTitle" 
          name="title" 
          required
          class="input-field"
          placeholder="Ingrese el título del video"
        />
      </div>

      <!-- Descripción -->
      <div>
        <label for="videoDescription" class="block text-sm font-medium text-text mb-2">Descripción *</label>
        <textarea 
          id="videoDescription" 
          name="description" 
          required
          rows="4"
          class="input-field resize-none"
          placeholder="Ingrese la descripción del video"
        ></textarea>
      </div>

      <!-- Video -->
      <div>
        <label class="block text-sm font-medium text-text mb-2">Video *</label>
        <div class="space-y-4">
          <!-- Opción 1: Subir archivo -->
          <div>
            <label class="flex items-center gap-2 text-text">
              <input 
                type="radio" 
                name="videoOption" 
                value="upload" 
                checked
                onchange="toggleVideoOption()"
                class="text-accent focus:ring-accent"
              />
              <span>Subir archivo de video</span>
            </label>
            <div id="videoUploadSection" class="mt-2">
              <input 
                type="file" 
                id="videoFile" 
                name="videoFile" 
                accept="video/*"
                class="input-field"
              />
            </div>
          </div>

          <!-- Opción 2: URL -->
          <div>
            <label class="flex items-center gap-2 text-text">
              <input 
                type="radio" 
                name="videoOption" 
                value="url" 
                onchange="toggleVideoOption()"
                class="text-accent focus:ring-accent"
              />
              <span>URL del video</span>
            </label>
            <div id="videoUrlSection" class="mt-2 hidden">
              <input 
                type="url" 
                id="videoUrl" 
                name="videoUrl" 
                class="input-field"
                placeholder="https://ejemplo.com/video.mp4"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Miniatura -->
      <div>
        <label for="videoThumbnail" class="block text-sm font-medium text-text mb-2">Miniatura</label>
        <input 
          type="file" 
          id="videoThumbnail" 
          name="thumbnail" 
          accept="image/*"
          class="input-field"
        />
        <p class="text-sm text-gray3 mt-1">Formatos soportados: JPEG, JPG, PNG, WebP. Máximo 10MB.</p>
      </div>

      <!-- Botones -->
      <div class="flex justify-end gap-4 pt-4">
        <button 
          type="button" 
          onclick="window.customModal.hide('addVideoModal')"
          class="px-4 py-2 text-text bg-gray2 rounded-lg hover:bg-gray3 transition-colors"
        >
          Cancelar
        </button>
        <button 
          type="submit" 
          class="px-4 py-2 bg-accent text-black rounded-lg hover:brightness-90 transition-colors font-medium"
        >
          Agregar Video
        </button>
      </div>
    </form>
  </div>
</CustomModal>

<!-- Modal para editar video -->
<CustomModal id="editVideoModal" class="w-full max-w-4xl">
  <div class="bg-gray0 rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto border border-gray2">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-text">Editar Video</h3>
      <button onclick="window.customModal.hide('editVideoModal')" class="text-gray3 hover:text-text transition-colors">
        <Icon name="xmark" class="w-6 h-6 fill-current" />
      </button>
    </div>

    <form id="editVideoForm" class="space-y-6">
      <input type="hidden" id="editVideoId" name="id" />
      
      <!-- Título -->
      <div>
        <label for="editVideoTitle" class="block text-sm font-medium text-text mb-2">Título *</label>
        <input 
          type="text" 
          id="editVideoTitle" 
          name="title" 
          required
          class="input-field"
          placeholder="Ingrese el título del video"
        />
      </div>

      <!-- Descripción -->
      <div>
        <label for="editVideoDescription" class="block text-sm font-medium text-text mb-2">Descripción *</label>
        <textarea 
          id="editVideoDescription" 
          name="description" 
          required
          rows="4"
          class="input-field resize-none"
          placeholder="Ingrese la descripción del video"
        ></textarea>
      </div>

      <!-- Video -->
      <div>
        <label class="block text-sm font-medium text-text mb-2">Video</label>
        <div class="space-y-4">
          <!-- Opción 1: Subir archivo -->
          <div>
            <label class="flex items-center gap-2 text-text">
              <input 
                type="radio" 
                name="editVideoOption" 
                value="upload" 
                checked
                onchange="toggleEditVideoOption()"
                class="text-accent focus:ring-accent"
              />
              <span>Subir archivo de video</span>
            </label>
            <div id="editVideoUploadSection" class="mt-2">
              <input 
                type="file" 
                id="editVideoFile" 
                name="videoFile" 
                accept="video/*"
                class="input-field"
              />
            </div>
          </div>

          <!-- Opción 2: URL -->
          <div>
            <label class="flex items-center gap-2 text-text">
              <input 
                type="radio" 
                name="editVideoOption" 
                value="url" 
                onchange="toggleEditVideoOption()"
                class="text-accent focus:ring-accent"
              />
              <span>URL del video</span>
            </label>
            <div id="editVideoUrlSection" class="mt-2 hidden">
              <input 
                type="url" 
                id="editVideoUrl" 
                name="videoUrl" 
                class="input-field"
                placeholder="https://ejemplo.com/video.mp4"
              />
            </div>
          </div>
        </div>
        <p class="text-sm text-gray3 mt-1">Deja vacío para mantener el video actual.</p>
      </div>

      <!-- Miniatura -->
      <div>
        <label for="editVideoThumbnail" class="block text-sm font-medium text-text mb-2">Miniatura</label>
        <input 
          type="file" 
          id="editVideoThumbnail" 
          name="thumbnail" 
          accept="image/*"
          class="input-field"
        />
        <p class="text-sm text-gray3 mt-1">Formatos soportados: JPEG, JPG, PNG, WebP. Máximo 10MB. Deja vacío para mantener la miniatura actual.</p>
      </div>

      <!-- Botones -->
      <div class="flex justify-end gap-4 pt-4">
        <button 
          type="button" 
          onclick="window.customModal.hide('editVideoModal')"
          class="px-4 py-2 text-text bg-gray2 rounded-lg hover:bg-gray3 transition-colors"
        >
          Cancelar
        </button>
        <button 
          type="submit" 
          class="px-4 py-2 bg-accent text-black rounded-lg hover:brightness-90 transition-colors font-medium"
        >
          Actualizar Video
        </button>
      </div>
    </form>
  </div>
</CustomModal>

<script is:inline>
  // Función para obtener datos de un video específico
  function getVideoData(id) {
    // Buscar en el DOM para obtener los datos
    const row = document.querySelector(`tr[data-id="${id}"]`);
    
    if (row) {
      const thumbnailImg = row.querySelector('td:nth-child(3) img');
      
      const videoData = {
        id: id,
        title: row.querySelector('td:nth-child(1)')?.textContent?.trim() || '',
        description: row.querySelector('td:nth-child(2)')?.textContent?.trim() || '',
        uploadedAt: formatDateForInput(row.querySelector('td:nth-child(5)')?.textContent?.trim() || ''),
        thumbnailPath: thumbnailImg ? thumbnailImg.src.replace(window.location.origin, '') : '',
        videoPath: '' // No podemos obtener esto del DOM, pero no es necesario para mostrar
      };
      
      return videoData;
    }

    return null;
  }

  function formatDateForInput(dateText) {
    // Convertir fecha de formato español a formato input date
    const months = {
      'enero': '01', 'febrero': '02', 'marzo': '03', 'abril': '04',
      'mayo': '05', 'junio': '06', 'julio': '07', 'agosto': '08',
      'septiembre': '09', 'octubre': '10', 'noviembre': '11', 'diciembre': '12'
    };
    
    const parts = dateText.split(' ');
    if (parts.length >= 3) {
      const day = parts[0].padStart(2, '0');
      const month = months[parts[2].toLowerCase()] || '01';
      const year = parts[4];
      return `${year}-${month}-${day}`;
    }
    return '';
  }

  function onVideoAdd() {
    window.customModal.show('addVideoModal');
  }

  function onVideoEdit(id) {
    const video = getVideoData(id);
    if (!video) {
      window.customAlert.error.show(
        'Error',
        'No se pudo encontrar el video para editar.'
      );
      return;
    }

    // Mostrar el modal primero
    window.customModal.show('editVideoModal');
    
    // Usar un delay más largo para asegurar que el modal se ha renderizado completamente
    setTimeout(() => {
      // Verificar que los elementos existen antes de intentar llenarlos
      const editIdElement = document.getElementById('editVideoId');
      const editTitleElement = document.getElementById('editVideoTitle');
      const editDescriptionElement = document.getElementById('editVideoDescription');
      
      if (editIdElement && editTitleElement && editDescriptionElement) {
        // Llenar el formulario con los datos del video
        editIdElement.value = video.id;
        editTitleElement.value = video.title;
        editDescriptionElement.value = video.description;

        // Configurar opción de video por defecto a upload
        const uploadRadio = document.querySelector('input[name="editVideoOption"][value="upload"]');
        if (uploadRadio) {
          uploadRadio.checked = true;
        }
        
        const editVideoUrlElement = document.getElementById('editVideoUrl');
        if (editVideoUrlElement) {
          editVideoUrlElement.value = '';
        }
        
        toggleEditVideoOption();

        // Limpiar campos de archivo para evitar conflictos
        const editVideoFileElement = document.getElementById('editVideoFile');
        const editThumbnailElement = document.getElementById('editVideoThumbnail');
        
        if (editVideoFileElement) {
          editVideoFileElement.value = '';
        }
        if (editThumbnailElement) {
          editThumbnailElement.value = '';
        }
      } else {
      }
    }, 300); // Aumentamos el delay a 300ms
  }

  function onVideoDelete(id) {
    const video = getVideoData(id);
    const title = video ? video.title : 'este video';
    
    if (confirm(`¿Estás seguro de que deseas eliminar "${title}"? Esta acción no se puede deshacer.`)) {
      const formData = new FormData();
      formData.append('id', id);

      fetch('/api/videos', {
        method: 'DELETE',
        body: formData
      }).then(response => {
        return response.json();
      }).then(data => {
        if (data.status === 200) {
          window.customAlert.success.show(
            'Video eliminado',
            data.message || 'El video ha sido eliminado exitosamente.',
            '',
            () => location.reload()
          );
        } else {
          window.customAlert.error.show(
            'Error al eliminar',
            data.message || 'Ocurrió un error al eliminar el video.',
          );
        }
      }).catch(error => {
        window.customAlert.error.show(
          'Error al eliminar',
          'Ocurrió un error al eliminar el video.',
        );
      });
    }
  }

  function toggleVideoOption() {
    const videoUploadSection = document.getElementById('videoUploadSection');
    const videoUrlSection = document.getElementById('videoUrlSection');
    const videoFileInput = document.getElementById('videoFile');
    const videoUrlInput = document.getElementById('videoUrl');
    const thumbnailInput = document.getElementById('videoThumbnail');
    
    const selectedOption = document.querySelector('input[name="videoOption"]:checked').value;
    
    if (selectedOption === 'upload') {
      videoUploadSection.classList.remove('hidden');
      videoUrlSection.classList.add('hidden');
      videoFileInput.required = true;
      videoUrlInput.required = false;
      videoUrlInput.value = '';
      // La miniatura es opcional para archivos subidos
      thumbnailInput.required = false;
    } else {
      videoUploadSection.classList.add('hidden');
      videoUrlSection.classList.remove('hidden');
      videoFileInput.required = false;
      videoUrlInput.required = true;
      videoFileInput.value = '';
      // La miniatura es opcional para URLs también
      thumbnailInput.required = false;
    }
  }

  function toggleEditVideoOption() {
    const videoUploadSection = document.getElementById('editVideoUploadSection');
    const videoUrlSection = document.getElementById('editVideoUrlSection');
    const videoFileInput = document.getElementById('editVideoFile');
    const videoUrlInput = document.getElementById('editVideoUrl');
    
    const selectedOption = document.querySelector('input[name="editVideoOption"]:checked').value;
    
    if (selectedOption === 'upload') {
      videoUploadSection.classList.remove('hidden');
      videoUrlSection.classList.add('hidden');
      videoFileInput.required = false; // No requerido en edición
      videoUrlInput.required = false;
      videoUrlInput.value = '';
    } else {
      videoUploadSection.classList.add('hidden');
      videoUrlSection.classList.remove('hidden');
      videoFileInput.required = false;
      videoUrlInput.required = false; // No requerido en edición
      videoFileInput.value = '';
    }
  }

  // Manejar el envío del formulario de agregar
  document.addEventListener('DOMContentLoaded', function() {
    const addForm = document.getElementById('addVideoForm');
    const editForm = document.getElementById('editVideoForm');
    
    addForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(addForm);
      
      // Manejar la opción de video seleccionada
      const videoOption = formData.get('videoOption');
      if (videoOption === 'url') {
        formData.delete('videoFile');
      } else {
        formData.delete('videoUrl');
      }
      formData.delete('videoOption');
      
      fetch('/api/videos', {
        method: 'POST',
        body: formData
      }).then(response => {
        return response.json();
      }).then(data => {
        if (data.status === 200) {
          window.customModal.hide('addVideoModal');
          window.customAlert.success.show(
            'Video agregado',
            data.message || 'El video ha sido agregado exitosamente.',
            '',
            () => location.reload()
          );
          addForm.reset();
        } else {
          window.customAlert.error.show(
            'Error al agregar',
            data.message || 'Ocurrió un error al agregar el video.',
          );
        }
      }).catch(error => {
        window.customAlert.error.show(
          'Error al agregar',
          'Ocurrió un error al agregar el video.',
        );
      });
    });

    // Manejar el envío del formulario de editar
    editForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(editForm);
      
      // Manejar la opción de video seleccionada
      const videoOption = formData.get('editVideoOption');
      if (videoOption === 'url') {
        formData.delete('videoFile');
        // Asegurar que la URL del video se envíe correctamente
        const videoUrl = formData.get('videoUrl');
        if (videoUrl && videoUrl.toString().trim() !== '') {
          formData.set('videoUrl', videoUrl.toString().trim());
        }
      } else {
        formData.delete('videoUrl');
        // Solo incluir el archivo si se ha seleccionado uno
        const videoFile = formData.get('videoFile');
        if (!videoFile || videoFile.size === 0) {
          formData.delete('videoFile');
        }
      }
      formData.delete('editVideoOption');
      
      // Manejar la miniatura - solo incluir si se ha seleccionado una nueva
      const thumbnail = formData.get('thumbnail');
      if (!thumbnail || thumbnail.size === 0) {
        formData.delete('thumbnail');
      }
      
      fetch('/api/videos', {
        method: 'PATCH',
        body: formData
      }).then(response => {
        return response.json();
      }).then(data => {
        if (data.status === 200) {
          window.customModal.hide('editVideoModal');
          window.customAlert.success.show(
            'Video actualizado',
            data.message || 'El video ha sido actualizado exitosamente.',
            '',
            () => location.reload()
          );
        } else {
          window.customAlert.error.show(
            'Error al actualizar',
            data.message || 'Ocurrió un error al actualizar el video.',
          );
        }
      }).catch(error => {
        window.customAlert.error.show(
          'Error al actualizar',
          'Ocurrió un error al actualizar el video.',
        );
      });
    });
  });
</script>

<style>
  @import "../../../../styles/global.css";

  #videosTable td:nth-child(1) {
    @apply min-w-88 max-w-88;
  }

  #videosTable td:nth-child(2) {
    @apply min-w-72 max-w-72;
  }

  #videosTable td:nth-child(3) {
    @apply min-w-32 max-w-32;
  }

  #videosTable td:nth-child(4) {
    @apply min-w-40 max-w-40;
  }

  #videosTable td:nth-child(5) {
    @apply min-w-42 max-w-42;
  }

  #videosTable td:nth-child(6) {
    @apply min-w-40 max-w-40;
  }

  #videosTable td:nth-child(7) {
    @apply min-w-32 max-w-32;
  }

  #videosTable td:nth-child(8) {
    @apply min-w-32 max-w-32;
  }
</style>

